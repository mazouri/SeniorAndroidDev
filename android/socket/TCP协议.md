# TCP协议

## 什么是TCP协议？

TCP是Transmission Control Protocol的缩写，也就是传输控制协议，它是一种传输层通信协议。

> 基于TCP的应用层协议有**FTP**、**Telnet**、**SMTP**、**HTTP**、**POP3**与**DNS**

## TCP协议有什么特点？

TCP协议是面向连接、面向字节流、全双工通信、可靠的。

### 1.面向连接？（像打电话）

指的是要使用TCP传输数据，必须先建立TCP连接，传输完成后释放连接，就像打电话一样必须先拨号建立一条连接，打完后挂机释放连接

### 2.面向字节流？

流，指的是流入到进程或从进程流出的字符序列。

简单来说，虽然有时候要传输的数据流太大，TCP报文长度有限制，不能一次传输完，要把它分为好几个数据块，但是由于可靠性保证，接收方可以按顺序接收数据块然后重新组成分块之前的数据流，所以TCP看起来就像直接互相传输字节流一样，面向字节流

### 3.全双工通信？

一旦建立了TCP连接，通信双方可以在任何时候都能发送数据

### 4.可靠的

指的是通过TCP连接传送的数据，无差错，不丢失，不重复，并且按序到达。

## TCP建立连接时的三次握手

<img src="http://upload-images.jianshu.io/upload_images/944365-ca6e707d5bef40fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">

使用TCP建立连接时必须进行三次握手。若A要与B进行连接，则必须：

- 第一次握手：建立连接。客户端发送连接请求报文段，将SYN位置为1，Sequence Number为x；然后，客户端进入SYN_SEND状态，等待服务器的确认。即A发送信息给B
- 第二次握手：服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认。即B收到连接信息后向A返回确认信息
- 第三次握手：客户端收到服务器的（SYN+ACK）报文段，并向服务器发送ACK报文段。即A收到确认信息后再次向B返回确认连接信息

> 此时，A告诉自己上层连接建立；B收到连接信息后告诉上层连接建立。

**这样就完成TCP三次握手 = 一条TCP连接建立完成 = 可以开始发送数据**

> 注意：三次握手期间任何一次未收到对面回复都要重发
> 最后一个确认报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态。

## 为什么TCP建立连接需要三次握手？

防止服务器端因为接收了早已失效的连接请求报文从而一直等待客户端请求，从而浪费资源

> “已失效的连接请求报文段”的产生在这样一种情况下：Client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达server。

> 这是一个早已失效的报文段。但Server收到此失效的连接请求报文段后，就误认为是Client再次发出的一个新的连接请求。
于是就向Client发出确认报文段，同意建立连接。

> 假设不采用“三次握手”：只要Server发出确认，新的连接就建立了。

> 由于现在Client并没有发出建立连接的请求，因此不会向Server发送数据。
但Server却以为新的运输连接已经建立，并一直等待Client发来数据。>- 这样，Server的资源就白白浪费掉了。

采用“三次握手”的办法可以防止上述现象发生：

- Client不会向Server的确认发出确认
- Server由于收不到确认，就知道Client并没有要求建立连接
- 所以Server不会等待Client发送数据，资源就没有被浪费

## TCP释放连接的四次挥手

<img src="http://upload-images.jianshu.io/upload_images/944365-a59e6fb7b501f1e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">

TCP释放连接需要四次挥手过程，现在假设A主动释放连接：（数据传输结束后，通信的双方都可释放连接）

- 第一次挥手：A发送释放信息到B；（发出去之后，A->B发送数据这条路径就断了）
- 第二次挥手：B收到A的释放信息之后，回复确认释放的信息：我同意你的释放连接请求
- 第三次挥手：B发送“请求释放连接“信息给A
- 第四次挥手：A收到B发送的信息后向B发送确认释放信息：我同意你的释放连接请求

> B收到确认信息后就会正式关闭连接；A等待2MSL后依然没有收到回复，则证明B端已正常关闭，于是A关闭连接
> MSL(Maximum Segment Lifetime):报文最长存活时间(Time_wait = 2*MSL 大约1-4分钟)

## 为什么TCP释放连接需要四次挥手？

为了保证双方都能通知对方“需要释放连接”，即在释放连接后都无法接收或发送消息给对方。

需要明确的是：TCP是全双工模式，这意味着是双向都可以发送、接收的

释放连接的定义是：双方都无法接收或发送消息给对方，是双向的。

当主机1发出“释放连接请求”（FIN报文段）时，只是表示主机1已经没有数据要发送 / 数据已经全部发送完毕；但是，这个时候主机1还是可以接受来自主机2的数据。

当主机2返回“确认释放连接”信息（ACK报文段）时，表示它已经知道主机1没有数据发送了；但此时主机2还是可以发送数据给主机1

当主机2也发送了FIN报文段时，即告诉主机1我也没有数据要发送了。

此时，主机1和2已经无法进行通信：主机1无法发送数据给主机2，主机2也无法发送数据给主机1，此时，TCP的连接才算释放








